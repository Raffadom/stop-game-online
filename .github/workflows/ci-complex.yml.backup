name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  CI: true

jobs:
  # Job 1: Install dependencies and cache
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache dependencies
        id: cache-deps
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            stop-game-frontend/node_modules
            stop-game-backend/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-deps-

      - name: Install root dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
          fi

      - name: Install frontend dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd stop-game-frontend
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
          fi

      - name: Install backend dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          cd stop-game-backend
          if [ -f package-lock.json ]; then
            npm ci --legacy-peer-deps
          else
            npm install --legacy-peer-deps
          fi

  # Job 2: Lint and code quality
  lint:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            stop-game-frontend/node_modules
            stop-game-backend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Lint frontend
        run: cd stop-game-frontend && npm run lint

      - name: Check frontend build
        run: cd stop-game-frontend && npm run build

  # Job 3: Unit tests - Frontend
  unit-tests-frontend:
    name: Unit Tests - Frontend
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            stop-game-frontend/node_modules
            stop-game-backend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Run frontend unit tests
        run: cd stop-game-frontend && npm run test:unit

      - name: Upload frontend coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./stop-game-frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  # Job 4: Unit tests - Backend
  unit-tests-backend:
    name: Unit Tests - Backend
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            stop-game-frontend/node_modules
            stop-game-backend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Run backend unit tests
        run: cd stop-game-backend && npm run test:unit

      - name: Upload backend coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./stop-game-backend/coverage/lcov.info
          flags: backend
          name: backend-coverage

  # Job 5: E2E Tests
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [setup, lint]
    strategy:
      matrix:
        browser: [chrome, firefox]
        viewport: [desktop, mobile]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            stop-game-frontend/node_modules
            stop-game-backend/node_modules
            ~/.cache/Cypress
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Build frontend
        run: cd stop-game-frontend && npm run build

      - name: Start backend server
        run: |
          cd stop-game-backend && npm start &
          sleep 10
        env:
          NODE_ENV: test

      - name: Start frontend server
        run: |
          cd stop-game-frontend && npm run preview &
          sleep 10

      - name: Wait for servers
        run: |
          npx wait-on http://localhost:3000 http://localhost:4173 --timeout 60000

      - name: Run Cypress tests
        run: npm run cypress:run:ci
        env:
          CYPRESS_BROWSER: ${{ matrix.browser }}
          CYPRESS_VIEWPORT: ${{ matrix.viewport }}

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.browser }}-${{ matrix.viewport }}
          path: cypress/screenshots

      - name: Upload videos
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: cypress-videos-${{ matrix.browser }}-${{ matrix.viewport }}
          path: cypress/videos

  # Job 6: Security & Vulnerability Check
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run security audit - Root
        run: npm audit --audit-level=moderate

      - name: Run security audit - Frontend
        run: cd stop-game-frontend && npm audit --audit-level=moderate

      - name: Run security audit - Backend
        run: cd stop-game-backend && npm audit --audit-level=moderate

  # Job 7: Performance Tests (opcional)
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [unit-tests-frontend, unit-tests-backend]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            stop-game-frontend/node_modules
            stop-game-backend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Build and start servers
        run: |
          cd stop-game-frontend && npm run build && npm run preview &
          cd stop-game-backend && npm start &
          sleep 15

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

  # Job 8: Deploy (condicional)
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [e2e-tests, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository_owner == 'Raffadom'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore dependencies
        uses: actions/cache@v3
        with:
          path: |
            stop-game-frontend/node_modules
          key: ${{ runner.os }}-deps-${{ hashFiles('**/package-lock.json') }}

      - name: Build production
        run: |
          cd stop-game-frontend && npm run build

      - name: Deploy to Netlify
        uses: netlify/actions/deploy@master
        with:
          publish-dir: ./stop-game-frontend/dist
          production-branch: main
          production-deploy: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Notify deployment success
        run: |
          echo "ðŸš€ Deployment successful!"
          echo "Check your application at the deployed URL"